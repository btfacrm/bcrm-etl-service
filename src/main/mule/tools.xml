<?xml version="1.0" encoding="UTF-8"?>

<mule
    xmlns:tls="http://www.mulesoft.org/schema/mule/tls"
 	xmlns:db="http://www.mulesoft.org/schema/mule/db"
    xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" 
	xmlns="http://www.mulesoft.org/schema/mule/core" 
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
	xsi:schemaLocation="
		http://www.mulesoft.org/schema/mule/ee/core 
		http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd 
		http://www.mulesoft.org/schema/mule/core 
		http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/http
        http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd 
		http://www.mulesoft.org/schema/mule/db 
		http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
		http://www.mulesoft.org/schema/mule/tls
		http://www.mulesoft.org/schema/mule/tls/current/mule-tls.xsd">
	
    <sub-flow name="read-watermark">

        <ee:transform doc:name="query watermark" >
			<ee:variables >
				<ee:set-variable variableName="query"><![CDATA[#[ %dw 2.0
					output application/json
					---
                    " SELECT ViewName, FORMAT(LastExecution, 'yyyy-MM-dd HH:mm:ss.fff') AS LastExecution " ++
                    " FROM Watermark " ++ 
                    " WHERE ViewName = '" ++ vars.view ++ "'"
				]]]>
				</ee:set-variable>
			</ee:variables>
		</ee:transform>

        <flow-ref name="mssql-query"/>

    </sub-flow>

    <sub-flow name="mssql-query">

        <logger doc:name="sql query" level="INFO" category="app"
            message="#[output application/java --- vars.query]"/>

		<db:select doc:name="sqlserver select" config-ref="Database_Config">
            <db:sql><![CDATA[#[ vars.query ]]]></db:sql>
			<db:input-parameters ><![CDATA[#[{ 
				validFrom: vars.validFrom,
				maxRecords: vars.maxRecords }]]]>
			</db:input-parameters>
		</db:select>

        <logger doc:name="result" level="INFO" category="app"
            message="#[output application/json --- if ( payload != null) payload else 'No records found']"/>

        <logger doc:name="total records" level="INFO" category="app" 
            message="#[${file::script-records-found.dwl}]"/>

	</sub-flow>

    <sub-flow name="mssql-update">

        <logger doc:name="sql update" level="INFO" category="app"
            message="#[output application/java --- vars.query]"/>

		<db:update doc:name="sqlserver update" config-ref="Database_Config">
            <db:sql><![CDATA[#[ vars.query ]]]></db:sql>
			<db:input-parameters ><![CDATA[#[{ 
				validFrom: vars.validFrom,
				apiResponse: vars.apiResponse }]]]>
			</db:input-parameters>
		</db:update>

        <logger doc:name="result" level="INFO" category="app"
            message="#[output application/json --- if ( payload != null) payload else 'No records found']"/>

        <logger doc:name="total records" level="INFO" category="app" 
            message="#[${file::script-records-found.dwl}]"/>

	</sub-flow>

	<sub-flow name="http-post">
		<logger doc:name="call post method" level="INFO" category="app" 
			message='#[ "Call POST method, path: " ++ vars.servicePath ++ ", statusValidator: " ++ (vars.statusValidator as String) ]' />

		<logger doc:name="payload" level="INFO" category="app" message="#[payload]"/>

		<http:request method="POST" config-ref="HTTP_Request_Configuration" path="#[vars.servicePath]">
			<http:headers><![CDATA[#[output application/java ---
				{
					"Content-Type"  : "application/json",
                    "client_id"     : "${service.clientid}",
                    "client_secret" : "${service.clientsecret}"
				}]]]>
			</http:headers>
			<http:response-validator>
				<http:success-status-code-validator values="#[vars.statusValidator]" />
			</http:response-validator>
		</http:request>
		<logger doc:name="result" level="INFO" message='#[payload]' />
	</sub-flow>

    <sub-flow name="send-api">

		<try doc:name="send to salesforce">

            <flow-ref name="http-post"/>

			<error-handler>
				<on-error-continue/>	
			</error-handler>
		</try>

        <!-- Update Watermark-->
        <set-variable doc:name="set apiResponse" variableName="apiResponse" value='#[write(payload, "application/json")]'  />
        <ee:transform doc:name="update watermark" >
			<ee:variables >
				<ee:set-variable variableName="query"><![CDATA[#[ %dw 2.0
					output application/json
					---
                    " UPDATE Watermark SET LastResponse = :apiResponse  WHERE ViewName = '" ++ vars.view ++ "'"
				]]]>
				</ee:set-variable>
			</ee:variables>
		</ee:transform>
        <flow-ref name="mssql-update"/>

        <flow-ref name="response"/>
	</sub-flow>

    <sub-flow name="response">

		<set-variable doc:name="message" variableName="message" value="#['View processed: ' ++ vars.view]"  />
		<set-variable doc:name="httpStatus" variableName="httpStatus" value="#['200']"  />
		<set-variable doc:name="service time" variableName="serviceProcessingTime" value="#[(now() as Number {unit: 'milliseconds'}) - vars.start]"  />

        <ee:transform doc:name="response" >
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
					output application/json
					---
					{
						message: vars.message,
						status: vars.httpStatus,
						serviceProcessingTime: vars.serviceProcessingTime,
						correlationId: correlationId
					}
					]]>
				</ee:set-payload>
			</ee:message>
		</ee:transform>		        
    </sub-flow>
</mule>
